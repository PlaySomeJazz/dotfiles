#!/bin/sh
export LC_ALL=C

: 'These paths should be portable, unless using multiple batteries or dongles'
batt=`echo /sys/class/power_supply/BAT?*`
btooth=`echo /sys/class/bluetooth/hci0/rfkill*/state`
wifi=`echo /sys/class/net/w*/operstate`
flag=`echo /sys/class/net/w*/flags`
ethernet=`echo /sys/class/net/e*/operstate`

: 'Run these when receiving signals or called, instead of every n seconds'
get_torr()
{
	t=0; while read -r _ p _; do case $p in 100%) ;; *%|n/a) t=$((t+1));;esac;done <<-EOF
	`transmission-remote -l 2>/dev/null`
	EOF
	test $t -ne 0 && t="  TORR $t  ::" || t=''
}
get_tasks()
{
	r=0 q=0; while read -r _ s _; do case $s in running) r=$((r+1)) ;; queued) q=$((q+1)) ;; esac; done <<- !
	`tsp 2>/dev/null`
	!
	ts=$((r+q)); test $ts -gt 0 && ts="  TSP $ts ($q)  ::" || ts=''
}
get_net()
{
	case $net in
		up)
			if ping -c 1 -W 1 1.1.1.1 > /dev/null 2>&1 || ping -c 1 -W 2 1.1.1.1 > /dev/null 2>&1
			then    nv=1 warn=''
			else    nv=0 warn='[ ! ] '
			fi
			for f in /sys/class/net/tun*/operstate; do [ -e $f ] && vpn='::  VPN on  ' || vpn='' && break; done
			;;
		*)
			read fl < $flag; test $fl = 0x1003 && net='[ w ]' || net='[ off ]'
			nv=0 warn=''
			;;
	esac
}
get_bt() { read bt < $btooth; test $bt -eq 1 && bt=on || bt=off; } ; get_bt

: 'Set your signals here'
trap get_tasks 10 ; trap get_torr 12 ; trap get_bt 34

: 'The loop'
n=0 cc=0 nv=0
while :; do
	n=$((n+1))
	time_date=`date '+%d %b (%a), %R'`
	read net < $wifi; read eth < $ethernet
	test $eth = up && eth='::  ETH on  ' || eth=''
	while read k v _;do case $k in MemTotal:)all=$v;;MemAvailable:)free=$v;break;;esac;done</proc/meminfo;mem=$(((all-free)*100/all))
	read raw_cpu < /sys/class/thermal/thermal_zone0/temp; cpu=${raw_cpu%000}Â°C
	set -- `df / --output=pcent`
	read bs<$batt/status;case "$bs" in Full)b='';;*)read c<$batt/capacity;test $c -le 25 && c="[ ! ] $c";b="  BATT $c% ($bs)  ::";;esac
	test \( $net = up -a $nv -eq 0 \) -o $net = down -o $n -eq 6 && get_net
	case $n in
		4) get_torr;;
		6) n=0; cc=$((cc+1)) ;;
	esac
	case $cc in
		6) cc=0;;
	esac
	xsetroot -name "$b$ts$t  DISK $2  |  RAM $mem%  |  TEMP $cpu  |  BT $bt  |  WIFI $warn$net  |  $time_date  $eth$vpn"
	sleep 10 & wait
done
