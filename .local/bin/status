#!/bin/sh
export LC_ALL=C

: These paths should be portable, unless using multiple batteries or dongles
B=`echo /sys/class/power_supply/BAT?*`
BS=$B/status
BC=$B/capacity
BT=`echo /sys/class/bluetooth/hci0/rfkill*/state`
W=`echo /sys/class/net/w*/operstate`
WF=`echo /sys/class/net/w*/flags`
E=`echo /sys/class/net/e*/operstate`

: Run these when called or when receiving signals, instead of every n seconds
torr()
{
	t=0
	while read -r _ p _; do
	case $p in 100%) ;; *%|n/a) t=$((t+1));; esac; done <<-EOF
	`transmission-remote -l`
	EOF
	test $t -ne 0 &&
	t="  TORR $t  ::" || t=''
}
tsk()
{
	r=0 q=0
	while read -r _ s _; do
	case $s in running) r=$((r+1)) ;; queued) q=$((q+1)) ;;esac;done <<- !
	`tsp`
	!
	ts=$((r+q)); test $ts -gt 0 &&
	ts="  TSP $ts ($q)  ::" || ts=''
}
cchk()
{
	case $net in
	up)	if ping -c 1 -W 1 1.1.1.1 > /dev/null 2>&1 ||
		ping -c 1 -W 2 1.1.1.1 > /dev/null 2>&1
		then	p=1 w=''
		else	p=0 w='[ ! ] '
		fi
		for f in /sys/class/net/tun*/operstate
		do	[ -e $f ] && vpn='::  VPN on  ' ||
			vpn='' && break
		done ;;
	*)	read fl < $WF
		test $fl = 0x1003 && net='[ w ]' || net='[ off ]'
		p=0 w='' ;;
	esac
}
btt() { read bt < $BT; test $bt -eq 1 && bt=on || bt=off; } ; btt

: Set your signals here
trap tsk 10
trap torr 12
trap btt 34

: The loop
td=`date '+%d %b (%a), %R'`
p=0
while :; do
	otd=$td
	td=`date '+%d %b (%a), %R'`
	read net < $W; read eth < $E
	test $eth = up && eth='::  ETH on  ' || eth=''
	while read k v _
	do	case $k in
		MemTotal:)	a=$v;;
		MemAvailable:)	f=$v; break;;
	esac
	done </proc/meminfo
	m=$(((a-f)*100/a))
	read rc < /sys/class/thermal/thermal_zone0/temp; cpu=${rc%000}Â°C
	set -- `df / --output=pcent`
	read bs<$BS
	case "$bs" in
	Full)	b='';;
	*)	read c <$BC
		test $c -le 25 && c="[ ! ] $c"
		b="  BATT $c% ($bs)  ::" ;;
	esac
	test \( $net = up -a $p -eq 0 \) -o \
			$net = down -o \
			"$td" != "$otd" &&
	cchk

	if test ! "$td" = "$otd"; then
		case $td in
		*[02468])	torr;;
		esac
	fi
	xsetroot -name \
		"$b$ts$t  DISK $2  |  RAM $m%  |  TEMP $cpu  |  BT $bt  |  WIFI $w$net  |  $td  $eth$vpn"
	sleep 10 & wait
done
