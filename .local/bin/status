#!/bin/ksh

: 'For dash use time_date=`date "+%d %b (%a), %R"` ; Signal 34 is RTMIN ; Most shells require `sleep 10 & wait $!`'

IFS='
'
export LC_ALL=C
batt=`echo /sys/class/power_supply/BAT?*` wifi=`echo /sys/class/net/w*/operstate` btooth=`echo /sys/class/bluetooth/hci0/rfkill*/state`
set -f
get_bt() { read bt < $btooth; [ $bt -eq 1 ] && bt=on || bt=off; } ; get_bt
get_torr() { set -- `transmission-remote -l 2>/dev/null`; t=$(( $# > 2 ? $# - 2 : 0 )); [ ${t:-0} -ne 0 ] && t="  TORR $t  ::" || t=''; }
get_tasks()
{
	r=0 q=0; while IFS=' ' read -r _ s _; do case $s in running) r=$((r + 1)) ;; queued) q=$((q + 1)) ;; esac; done <<- !
	`tsp 2>/dev/null`
	!
	ts=$((r + q)); [ $ts -gt 0 ] && ts="  TSP $ts ($q)  ::" || ts=''
}
update() {
	printf -v time_date '%(%d %b (%a), %R)T\n' -1
	read net < $wifi; [ $net = up -a ${net_val:-1} -eq 0 ] && net='[ ! ] up'
	while IFS=' ' read -r k v _;do case $k in MemTotal:)all=$v;;MemAvailable:)free=$v;break;;esac;done</proc/meminfo;mem=$(((all-free)*100/all))
	read r_cpu < /sys/class/thermal/thermal_zone0/temp; cpu=${r_cpu%000}Â°C
	set -- `df / --output=pcent`; disk=$2
	read bs<$batt/status;case "$bs" in Full)b='';;*)read c<$batt/capacity;[ $c -le 25 ] && c="[ ! ] $c";b="  BATT $c% ($bs)  ::";;esac
	xsetroot -name "$b$ts$t  DISK$disk  |  RAM $mem%  |  TEMP $cpu  |  BT $bt  |  WIFI $net  |  $time_date  "
}
trap get_tasks 10 ; trap get_torr 12 ; trap get_bt 34 ; trap net_val=1 35 ; trap net_val=0 36
while :; do ping -c 2 -W 5 1.1.1.1 > /dev/null 2>&1 && kill -35 $$ || kill -36 $$; kill -12 $$; sleep 60; done &
while :; do update; sleep 10; done
