#!/bin/bash

########## CONFIGURATIONS ##########
# Host on which qBittorrent runs
transmission_host="http://localhost"
# Port -> the same port that is inside qBittorrent option -> Web UI -> Web User Interface
transmission_port="9091"
# Username to access to Web UI
transmission_username="transmission"
# Password to access to Web UI
transmission_password="transmission"

# Configure here your trackers list
declare -a live_trackers_list_urls=(
	"https://newtrackon.com/api/stable"
	"https://trackerslist.com/best.txt"
	"https://trackerslist.com/http.txt"
	"https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt"
	)
########## CONFIGURATIONS ##########

jq_executable="$(command -v jq)"
curl_executable="$(command -v curl)"
all_torrent=0

########## FUNCTIONS ##########
generate_trackers_list () {
	for j in "${live_trackers_list_urls[@]}"; do
		tmp_trackers_list+=$($curl_executable -sS $j)
		tmp_trackers_list+=$'\n'
	done

	trackers_list=$(echo "$tmp_trackers_list" | awk '{for (i=1;i<=NF;i++) if (!a[$i]++) printf("%s%s",$i,FS)}{printf("\n")}' | xargs | tr ' ' '\n')
	number_of_trackers_in_list=$(echo "$trackers_list" | wc -l)
}

inject_trackers () {
	start=1
	while read -r tracker; do
		if [ -n "$tracker" ]; then
			echo -ne "\e[0;36;1m$start/$number_of_trackers_in_list - Adding tracker $tracker\e[0;36m"
			$curl_executable --silent --fail --show-error --anyauth \
				--user ${transmission_username}:${transmission_password} --header "$qbt_cookie" "${transmission_host}:${transmission_port}/transmission/rpc/" \
				-d "{\"method\":\"torrent-set\",\"arguments\": {\"fields\":[\"ids\",\"trackerAdd\"],\"ids\":[$1],\"trackerAdd\":[\"$tracker\"]}}"

			if [ $? -eq 0 ]; then
				echo -e " -> \e[32mSuccess! "
			else
				echo -e " - \e[31m< Failed > "
			fi
		fi
		start=$((start+1))
	done <<< "$trackers_list"
	echo "Done!"
}

get_torrent_list () {
	get_cookie
	torrent_list=$($curl_executable --silent --anyauth \
		--user ${transmission_username}:${transmission_password} --header "$qbt_cookie" "${transmission_host}:${transmission_port}/transmission/rpc/" \
		-d "{\"method\":\"torrent-get\",\"arguments\": {\"fields\":[\"isPrivate\",\"id\",\"name\",\"hashString\",\"trackers\"]}}")
}

get_cookie () {
	qbt_cookie=$($curl_executable --silent --anyauth \
		--user ${transmission_username}:${transmission_password} ${transmission_host}:${transmission_port}/transmission/rpc/ \
		| sed 's/.*<code>//g;s/<\/code>.*//g')
}

########## FUNCTIONS ##########

	while getopts ":ai:" opt; do
		case ${opt} in
			a ) # If used inject trackers to all torrent.
				all_torrent=1
				;;
			i ) # Specify the id of the torrent example -i 5, multiple -i can be used.
				tor_arg_id+=("$OPTARG")
				;;
		esac
	done
	shift $((OPTIND -1))

	get_torrent_list

	if [ $all_torrent -eq 1 ]; then
		while IFS= read -r line; do
			torrent_id_array+=("$line")
		done < <(echo $torrent_list | $jq_executable --raw-output '. | .arguments | .torrents | .[] | .id')

		while IFS= read -r line; do
			torrent_name_array+=("$line")
		done < <(echo $torrent_list | $jq_executable --raw-output '. | .arguments | .torrents | .[] | .name')

		while IFS= read -r line; do
			torrent_private_array+=("$line")
		done < <(echo $torrent_list | $jq_executable --raw-output '. | .arguments | .torrents | .[] | .isPrivate')
		for i in "${tor_arg_id[@]}"; do
			torrent_name_list=$(echo "$torrent_list" | $jq_executable --raw-output --argjson tosearch "$i" '. | .arguments | .torrents | .[] | select(.id == $tosearch) .name')

			if [ -n "$torrent_name_list" ]; then # not empty
				torrent_name_check=1
			else
				torrent_name_check=0
			fi

			if [ $torrent_name_check -eq 0 ]; then
				shift
				continue
			else
				while read -r single_found; do
					torrent_name_array+=("$single_found")
					id=$(echo "$torrent_list" | $jq_executable --raw-output --arg tosearch "$single_found" '. | .arguments | .torrents | .[] | select(.name == "\($tosearch)") .id')
					torrent_id_array+=("$id")
					private=$(echo "$torrent_list" | $jq_executable --raw-output --arg tosearch "$single_found" '. | .arguments | .torrents | .[] | select(.name == "\($tosearch)") .isPrivate')
					torrent_private_array+=("$private")
				done <<< "$torrent_name_list"
			fi
		done
	fi
	if [ ${#torrent_name_array[@]} -gt 0 ]; then
		for i in "${!torrent_name_array[@]}"; do
				if [[ ${torrent_private_array[$i]} == true ]]; then
					private_tracker_name=$(echo "$torrent_list" | $jq_executable --raw-output --argjson tosearch "${torrent_id_array[$i]}" '. | .arguments | .torrents | .[] | select(.id == $tosearch) .trackers | .[] | .announce' | sed -e 's/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/')
				else
					[[ -z "$trackers_list" ]] && generate_trackers_list
					inject_trackers ${torrent_id_array[$i]}
				fi
		done
	else
		echo "No torrents found, exiting"
	fi
