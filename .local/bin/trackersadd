#!/bin/bash

transmission_host="http://localhost"
transmission_port="9091"
transmission_username="transmission"
transmission_password="transmission"

declare -a live_trackers_list_urls=(
	"https://newtrackon.com/api/stable"
	"https://trackerslist.com/best.txt"
	"https://trackerslist.com/http.txt"
	"https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt"
	)

jq_executable="$(command -v jq)"
curl_executable="$(command -v curl)"

generate_trackers_list () {
	for j in "${live_trackers_list_urls[@]}"; do
		tmp_trackers_list+=$($curl_executable -sS $j)
		tmp_trackers_list+=$'\n'
	done

	trackers_list=$(echo "$tmp_trackers_list" | awk '{for (i=1;i<=NF;i++) if (!a[$i]++) printf("%s%s",$i,FS)}{printf("\n")}' | xargs | tr ' ' '\n')
	number_of_trackers_in_list=$(echo "$trackers_list" | wc -l)
}

inject_trackers () {
	start=1
	while read -r tracker; do
		if [ -n "$tracker" ]; then
			echo -ne "\e[0;36;1m$start/$number_of_trackers_in_list - Adding tracker $tracker\e[0;36m"
			$curl_executable --silent --fail --show-error --anyauth \
				--user ${transmission_username}:${transmission_password} --header "$qbt_cookie" "${transmission_host}:${transmission_port}/transmission/rpc/" \
				-d "{\"method\":\"torrent-set\",\"arguments\": {\"fields\":[\"ids\",\"trackerAdd\"],\"ids\":[$1],\"trackerAdd\":[\"$tracker\"]}}"

			if [ $? -eq 0 ]; then
				echo -e " -> \e[32mSuccess! "
			else
				echo -e " - \e[31m< Failed > "
			fi
		fi
		start=$((start+1))
	done <<< "$trackers_list"
	echo "Done!"
}

get_torrent_list () {
	get_cookie
	torrent_list=$($curl_executable --silent --anyauth \
		--user ${transmission_username}:${transmission_password} --header "$qbt_cookie" "${transmission_host}:${transmission_port}/transmission/rpc/" \
		-d "{\"method\":\"torrent-get\",\"arguments\": {\"fields\":[\"isPrivate\",\"id\",\"name\",\"hashString\",\"trackers\"]}}")
}

get_cookie () {
	qbt_cookie=$($curl_executable --silent --anyauth \
		--user ${transmission_username}:${transmission_password} ${transmission_host}:${transmission_port}/transmission/rpc/ \
		| sed 's/.*<code>//g;s/<\/code>.*//g')
}

tor_arg_id=$1
	get_torrent_list

			torrent_name_list=$(echo "$torrent_list" | $jq_executable --raw-output --argjson tosearch "$tor_arg_id" '. | .arguments | .torrents | .[] | select(.id == $tosearch) .name')

					id=$(echo "$torrent_list" | $jq_executable --raw-output --arg tosearch "$torrent_name_list" '. | .arguments | .torrents | .[] | select(.name == "\($tosearch)") .id')
					private=$(echo "$torrent_list" | $jq_executable --raw-output --arg tosearch "$torrent_name_list" '. | .arguments | .torrents | .[] | select(.name == "\($tosearch)") .isPrivate')
				if [ $private = true ]; then
					private_tracker_name=$(echo "$torrent_list" | $jq_executable --raw-output --argjson tosearch "$id" '. | .arguments | .torrents | .[] | select(.id == $tosearch) .trackers | .[] | .announce' | sed -e 's/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/')
				else
					[ -z "$trackers_list" ] && generate_trackers_list
					inject_trackers $id
				fi
