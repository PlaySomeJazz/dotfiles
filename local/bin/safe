#!/bin/sh

if test $# -lt 3 -o \( "X$1" != Xmv -a "X$1" != Xcp \); then
	echo usage: safe command source ... directory 1>&2
	exit 1
fi

set -f

cmd=$1; shift
for dest do :; done
test ! -d "$dest" && echo bad directory 1>&2 && exit 1

extensions="
mp4 mkv wmv webm jpg jpeg png webp gif avif mp3 m4a m4b opus wav flac pdf PDF md
doc docx odt djvu azw3 epub mobi txt apk html tar.gz tar.bz2 tar.xz gz zip rar 7z
"

while test $# -gt 1; do
	file="${1##*/}"
	if test -e "$dest/$file" || test -L "$dest/$file"
	then	ext=
		case "$file" in
		?*.?*)	for i in $extensions
			do	case "$file" in
				*.$i)	ext=.$i
					break
				esac
			done
			name="${file%"$ext"}" ;;
		*)	name="$file"
		esac
		c=1
		while test -e "$dest/$file" || test -L "$dest/$file"; do
			file="${name}_COPY${c}${ext}"
			c=$((c+1))
		done
	fi
	$cmd -- "$1" "$dest/$file"
	shift
done
