#!/bin/sh

if test $# -lt 3 -o \( "$1" != mv -a "$1" != cp \)
then
	echo usage: $0 command source ... directory 1>&2
	exit
fi

set -f
cmd=$1;shift

for dest do :; done

while test $# -gt 1; do
	file="${1##*/}"
	if [ -e "$dest/$file" ] || [ -L "$dest/$file" ]; then
		case "$file" in
		?*.???.?? | ?*.???.???)
			name="${file%%.*}" ext=."${file#*.}"  ;;
		?*.*)
			name="${file%.*}"  ext=."${file##*.}" ;;
		*)
			name="$file"       ext=''
		esac
		c=1
		while [ -e "$dest/$file" ] || [ -L "$dest/$file" ]; do
			file="${name}_${c}${ext}"
			c=$((c+1))
		done
	fi
	$cmd -- "$1" "$dest/$file"
	shift
done
