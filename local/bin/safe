#!/bin/sh
set -f
cmd=$1;shift

if [ X"$1" = X-t ]; then
	shift
	dest=$1;shift
else
	for i do
		eval argv$#=\$i
		argv="\"\$argv$#\" $argv"
		shift
	done
	eval set x "$argv"
	shift
	dest=$1;shift
fi

for f do
    {
	filename="${f##*/}"
	newfile="$filename"
	if [ -e "$dest/$newfile" ]; then
		name="${filename%.*}"
		ext="${filename##*.}"
		[ "$name" = "$ext" ] && ext=""
		c=1
		while [ -e "$dest/$newfile" ]; do
			newfile="${name}_${c}.${ext}"
			c=$((c+1))
		done
	fi
	"$cmd" -- "$f" "$dest/$newfile"
    } &
done
